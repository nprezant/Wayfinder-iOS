-----------
-- Up
-----------

CREATE TABLE axis(
    id INTEGER PRIMARY KEY,
    name TEXT UNIQUE,
    hidden BOOL
);

CREATE INDEX indexAxisHidden ON axis(hidden);
INSERT INTO axis (name, hidden) VALUES ('Work', FALSE);

-- Adding the axis column to the reflection table
-- https://www.sqlite.org/lang_altertable.html

PRAGMA foreign_keys=OFF;
BEGIN TRANSACTION;

CREATE TABLE new_reflection(
    id INTEGER PRIMARY KEY,
    name TEXT,
    isFlowState BOOL,
    engagement INT,
    energy INT,
    date INT,
    note TEXT,
    axis INT REFERENCES axis
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);

INSERT INTO new_reflection SELECT *, 1 FROM reflection;

DROP TABLE reflection;
ALTER TABLE new_reflection RENAME TO reflection;

CREATE INDEX indexReflectionAxis ON reflection(axis);

PRAGMA foreign_key_check;

END TRANSACTION;
PRAGMA foreign_keys=ON;

-----------
-- Down
-----------

PRAGMA foreign_keys=OFF;
BEGIN TRANSACTION;

CREATE TABLE new_reflection(
    id INTEGER PRIMARY KEY,
    name TEXT,
    isFlowState BOOL,
    engagement INT,
    energy INT,
    date INT,
    note TEXT
);

INSERT INTO new_reflection SELECT id, name, isFlowState, engagement, energy, date, note FROM reflection;

DROP TABLE reflection;
ALTER TABLE new_reflection RENAME TO reflection;
DROP TABLE axis;

PRAGMA foreign_key_check;

END TRANSACTION;
PRAGMA foreign_keys=ON;
